<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Dashboard</title>
    <link rel="stylesheet" href="styles.css" />
    <style>
      .admin-container {
        max-width: 1200px;
        margin: 40px auto;
        padding: 20px;
      }
      .login-container {
        max-width: 400px;
        margin: 100px auto;
        background: white;
        padding: 40px;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      }
      .login-container h2 {
        text-align: center;
        margin-bottom: 24px;
      }
      .form-group {
        margin-bottom: 20px;
      }
      .form-group label {
        display: block;
        font-weight: 500;
        margin-bottom: 8px;
      }
      .form-group input,
      .form-group select {
        width: 100%;
        padding: 12px;
        border: 2px solid #ddd;
        border-radius: 8px;
        font-size: 14px;
      }
      .review-item {
        background: white;
        border: 2px solid #ddd;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 20px;
      }
      .review-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
      }
      .review-stars {
        color: #ffc107;
        font-size: 20px;
      }
      .review-text {
        background: #f5f8fa;
        padding: 16px;
        border-radius: 8px;
        margin: 12px 0;
        line-height: 1.6;
      }
      .review-actions {
        display: flex;
        gap: 12px;
        margin-top: 16px;
      }
      .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        font-size: 14px;
      }
      .btn-primary {
        background: var(--primary);
        color: white;
      }
      .btn-approve {
        background: #34c759;
        color: white;
      }
      .btn-delete {
        background: #ff3b30;
        color: white;
      }
      .btn-logout {
        background: #666;
        color: white;
        float: right;
      }
      .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #666;
      }
      .admin-section {
        background: white;
        border: 2px solid #ddd;
        border-radius: 12px;
        padding: 24px;
        margin-bottom: 30px;
      }
      .success-message {
        background: #d4edda;
        color: #155724;
        padding: 12px;
        border-radius: 8px;
        margin-top: 12px;
      }
      .error-message {
        background: #f8d7da;
        color: #721c24;
        padding: 12px;
        border-radius: 8px;
        margin-top: 12px;
      }
    </style>
  </head>
  <body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-container">
      <h2>üîí Admin Login</h2>
      <form id="loginForm">
        <div class="form-group">
          <label>Password</label>
          <input type="password" id="loginPassword" required>
        </div>
        <button type="submit" class="btn btn-primary" style="width: 100%;">Login</button>
      </form>
      <div id="loginError" style="margin-top: 12px; color: #ff3b30; display: none;"></div>
    </div>

    <!-- Admin Dashboard -->
    <div id="adminDashboard" class="admin-container" style="display: none;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
        <h1>Admin Dashboard</h1>
        <button class="btn btn-logout" onclick="logout()">Logout</button>
      </div>

      <!-- Rotate Keys -->
      <div class="admin-section">
        <h2>üîÅ Replace All Issued Keys</h2>
        <p style="color: #666; margin-bottom: 20px;">This replaces every issued key with a brand-new unused key from your pool.</p>
        <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
          <input type="checkbox" id="rotateSendEmails" />
          <span>Send updated keys to customers by email</span>
        </label>
        <button class="btn btn-primary" onclick="rotateKeys()">Run Key Replacement</button>
        <div id="rotateResult" style="margin-top: 12px;"></div>
      </div>

      <!-- Manual Key Sending -->
      <div class="admin-section">
        <h2>üìß Send License Key Manually</h2>
        <p style="color: #666; margin-bottom: 20px;">Send a unique license key to any email address.</p>
        <form id="sendKeyForm">
          <div class="form-group">
            <label>Customer Email</label>
            <input type="email" id="sendKeyEmail" required>
          </div>
          <div class="form-group">
            <label>Product</label>
            <select id="sendKeyProduct" required>
              <option value="BudgetXT">BudgetXT</option>
              <option value="AgendaXT">AgendaXT</option>
              <option value="InventoryXT">InventoryXT</option>
            </select>
          </div>
          <button type="submit" class="btn btn-primary">Send License Key</button>
        </form>
        <div id="sendKeyResult"></div>
      </div>

      <!-- Active Keys -->
      <div class="admin-section">
        <h2>üîë Active Keys</h2>
        <p style="color: #666; margin-bottom: 12px;">View active keys, email yourself a report, or deactivate and reissue.</p>
        <div style="display:flex; gap:12px; margin-bottom: 12px;">
          <button class="btn btn-primary" onclick="loadActiveKeys()">Refresh List</button>
          <button class="btn btn-primary" onclick="sendKeyReport()">Email Me Active Keys</button>
        </div>
        <div id="activeKeysResult"></div>
        <div id="activeKeysContainer"></div>
      </div>

      <!-- Review Moderation -->
      <div class="admin-section">
        <h2>‚≠ê Pending Reviews</h2>
        <p style="color: #666; margin-bottom: 20px;">Approve, edit, or delete customer reviews before they appear on the website.</p>
        <div id="reviewsContainer"></div>
      </div>

      <div class="admin-section">
        <h2>‚úÖ Approved Reviews</h2>
        <p style="color: #666; margin-bottom: 20px;">Edit, unpublish, or delete live reviews.</p>
        <div id="approvedReviewsContainer"></div>
      </div>
    </div>

    <script>
      let authToken = localStorage.getItem('adminToken');

      function adminHeaders() {
        return {
          'Content-Type': 'application/json',
          'x-admin-token': authToken || ''
        };
      }

      async function checkAuth() {
        if (!authToken) {
          showLogin();
          return false;
        }

        try {
          const response = await fetch('/api/admin/verify-token', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ token: authToken })
          });

          if (response.ok) {
            showDashboard();
            return true;
          } else {
            showLogin();
            return false;
          }
        } catch (error) {
          showLogin();
          return false;
        }
      }

      function showLogin() {
        document.getElementById('loginScreen').style.display = 'block';
        document.getElementById('adminDashboard').style.display = 'none';
      }

      function showDashboard() {
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('adminDashboard').style.display = 'block';
        loadPendingReviews();
        loadApprovedReviews();
      }

      function logout() {
        localStorage.removeItem('adminToken');
        authToken = null;
        showLogin();
      }

      document.getElementById('loginForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const password = document.getElementById('loginPassword').value;
        const errorDiv = document.getElementById('loginError');

        try {
          const response = await fetch('/api/admin/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ password })
          });

          const data = await response.json();

          if (response.ok) {
            authToken = data.token;
            localStorage.setItem('adminToken', authToken);
            showDashboard();
          } else {
            errorDiv.textContent = 'Invalid password';
            errorDiv.style.display = 'block';
          }
        } catch (error) {
          errorDiv.textContent = 'Login failed. Please try again.';
          errorDiv.style.display = 'block';
        }
      });

      document.getElementById('sendKeyForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = document.getElementById('sendKeyEmail').value;
        const appName = document.getElementById('sendKeyProduct').value;
        const resultDiv = document.getElementById('sendKeyResult');

        resultDiv.innerHTML = '<p>Sending license key...</p>';

        try {
          const response = await fetch('/api/admin/send-key', {
            method: 'POST',
            headers: adminHeaders(),
            body: JSON.stringify({ email, appName })
          });

          const data = await response.json();

          if (response.ok) {
            resultDiv.innerHTML = `
              <div class="success-message">
                <strong>‚úì Success!</strong><br>
                License Key: <code>${data.key}</code><br>
                Sent to: ${email}<br>
                ${data.warning || data.message}
              </div>
            `;
            document.getElementById('sendKeyForm').reset();
          } else {
            resultDiv.innerHTML = `
              <div class="error-message">
                <strong>‚úó Error:</strong> ${data.error}
              </div>
            `;
          }
        } catch (error) {
          resultDiv.innerHTML = `
            <div class="error-message">
              <strong>‚úó Error:</strong> Failed to send key
            </div>
          `;
        }
      });

      async function loadPendingReviews() {
        const container = document.getElementById('reviewsContainer');
        container.innerHTML = '<p style="text-align: center;">Loading reviews...</p>';
        
        try {
          const response = await fetch('/api/admin/pending-reviews', {
            headers: adminHeaders()
          });

          if (response.status === 401) {
            logout();
            return;
          }
          const data = await response.json();
          
          if (data.reviews.length === 0) {
            container.innerHTML = `
              <div class="empty-state">
                <div style="font-size: 64px; margin-bottom: 16px;">üì≠</div>
                <h3>No Pending Reviews</h3>
                <p>All caught up! New reviews will appear here for moderation.</p>
              </div>
            `;
            return;
          }
          
          container.innerHTML = data.reviews.map(review => `
            <div class="review-item" id="review-${review.id}">
              <div class="review-header">
                <div>
                  <strong>${review.name}</strong>
                  <br>
                  <small style="color: #666;">${review.email} ‚Ä¢ ${new Date(review.date).toLocaleDateString()}</small>
                </div>
                <div class="review-stars">
                  ${'‚òÖ'.repeat(review.rating)}${'‚òÜ'.repeat(5 - review.rating)}
                </div>
              </div>
              <div class="review-text">
                "${review.text}"
              </div>
              <div class="review-actions">
                <button class="btn btn-primary" onclick="editReview('${review.id}', 'pending')">‚úé Edit</button>
                <button class="btn btn-approve" onclick="approveReview('${review.id}')">
                  ‚úì Approve & Publish
                </button>
                <button class="btn btn-delete" onclick="deleteReview('${review.id}')">
                  ‚úó Delete
                </button>
              </div>
            </div>
          `).join('');
        } catch (error) {
          container.innerHTML = '<p style="color: red;">Error loading reviews. Please try again.</p>';
          console.error('Load error:', error);
        }
      }

      async function loadApprovedReviews() {
        const container = document.getElementById('approvedReviewsContainer');
        container.innerHTML = '<p style="text-align: center;">Loading approved reviews...</p>';

        try {
          const response = await fetch('/api/admin/approved-reviews', {
            headers: adminHeaders()
          });

          if (response.status === 401) {
            logout();
            return;
          }

          const data = await response.json();

          if (data.reviews.length === 0) {
            container.innerHTML = `
              <div class="empty-state">
                <div style="font-size: 64px; margin-bottom: 16px;">‚úÖ</div>
                <h3>No Approved Reviews</h3>
                <p>Approved reviews will appear here.</p>
              </div>
            `;
            return;
          }

          container.innerHTML = data.reviews.map(review => `
            <div class="review-item" id="approved-${review.id}">
              <div class="review-header">
                <div>
                  <strong>${review.name}</strong>
                  <br>
                  <small style="color: #666;">${review.email} ‚Ä¢ ${new Date(review.date).toLocaleDateString()}</small>
                </div>
                <div class="review-stars">
                  ${'‚òÖ'.repeat(review.rating)}${'‚òÜ'.repeat(5 - review.rating)}
                </div>
              </div>
              <div class="review-text">
                "${review.text}"
              </div>
              <div class="review-actions">
                <button class="btn btn-primary" onclick="editReview('${review.id}', 'approved')">‚úé Edit</button>
                <button class="btn btn-approve" onclick="unpublishReview('${review.id}')">‚Ü© Unpublish</button>
                <button class="btn btn-delete" onclick="deleteApprovedReview('${review.id}')">‚úó Delete</button>
              </div>
            </div>
          `).join('');
        } catch (error) {
          container.innerHTML = '<p style="color: red;">Error loading approved reviews. Please try again.</p>';
          console.error('Load error:', error);
        }
      }
      
      async function approveReview(reviewId) {
        if (!confirm('Approve this review and publish it on the website?')) return;
        
        try {
          const response = await fetch('/api/admin/approve-review', {
            method: 'POST',
            headers: adminHeaders(),
            body: JSON.stringify({ reviewId })
          });
          
          if (response.ok) {
            document.getElementById(`review-${reviewId}`).remove();
            if (document.querySelectorAll('.review-item').length === 0) {
              loadPendingReviews();
            }
            loadApprovedReviews();
          } else {
            alert('Error approving review');
          }
        } catch (error) {
          alert('Error approving review');
          console.error('Approve error:', error);
        }
      }
      
      async function deleteReview(reviewId) {
        if (!confirm('Delete this review permanently?')) return;
        
        try {
          const response = await fetch('/api/admin/delete-review', {
            method: 'POST',
            headers: adminHeaders(),
            body: JSON.stringify({ reviewId })
          });
          
          if (response.ok) {
            document.getElementById(`review-${reviewId}`).remove();
            if (document.querySelectorAll('.review-item').length === 0) {
              loadPendingReviews();
            }
          } else {
            alert('Error deleting review');
          }
        } catch (error) {
          alert('Error deleting review');
          console.error('Delete error:', error);
        }
      }

      async function unpublishReview(reviewId) {
        if (!confirm('Unpublish this review and move it back to pending?')) return;

        try {
          const response = await fetch('/api/admin/unpublish-review', {
            method: 'POST',
            headers: adminHeaders(),
            body: JSON.stringify({ reviewId })
          });

          if (response.ok) {
            document.getElementById(`approved-${reviewId}`).remove();
            loadPendingReviews();
          } else {
            alert('Error unpublishing review');
          }
        } catch (error) {
          alert('Error unpublishing review');
          console.error('Unpublish error:', error);
        }
      }

      async function deleteApprovedReview(reviewId) {
        if (!confirm('Delete this approved review permanently?')) return;

        try {
          const response = await fetch('/api/admin/delete-approved-review', {
            method: 'POST',
            headers: adminHeaders(),
            body: JSON.stringify({ reviewId })
          });

          if (response.ok) {
            document.getElementById(`approved-${reviewId}`).remove();
          } else {
            alert('Error deleting approved review');
          }
        } catch (error) {
          alert('Error deleting approved review');
          console.error('Delete approved error:', error);
        }
      }

      async function editReview(reviewId, status) {
        const name = prompt('Edit name (leave blank to keep current):');
        const text = prompt('Edit review text (leave blank to keep current):');
        const ratingStr = prompt('Edit rating 1-5 (leave blank to keep current):');
        const rating = ratingStr ? parseInt(ratingStr) : null;

        try {
          const response = await fetch('/api/admin/update-review', {
            method: 'POST',
            headers: adminHeaders(),
            body: JSON.stringify({ reviewId, status, name, text, rating })
          });

          if (response.ok) {
            if (status === 'pending') {
              loadPendingReviews();
            } else {
              loadApprovedReviews();
            }
          } else {
            alert('Error updating review');
          }
        } catch (error) {
          alert('Error updating review');
          console.error('Update review error:', error);
        }
      }

      async function rotateKeys() {
        const resultDiv = document.getElementById('rotateResult');
        const sendEmails = document.getElementById('rotateSendEmails').checked;
        if (!confirm('This will replace ALL issued keys. Continue?')) return;

        resultDiv.innerHTML = '<p>Replacing keys...</p>';

        try {
          const response = await fetch('/api/admin/rotate-keys', {
            method: 'POST',
            headers: adminHeaders(),
            body: JSON.stringify({ sendEmails })
          });

          const data = await response.json();

          if (response.ok) {
            resultDiv.innerHTML = `
              <div class="success-message">
                ‚úì Rotated ${data.rotated} key(s). Emails sent: ${data.emailsSent ? 'Yes' : 'No'}
              </div>
            `;
          } else {
            resultDiv.innerHTML = `
              <div class="error-message">‚úó ${data.error || 'Failed to rotate keys'}</div>
            `;
          }
        } catch (error) {
          resultDiv.innerHTML = '<div class="error-message">‚úó Failed to rotate keys</div>';
        }
      }

      async function loadActiveKeys() {
        const container = document.getElementById('activeKeysContainer');
        container.innerHTML = '<p>Loading active keys...</p>';

        try {
          const response = await fetch('/api/admin/active-keys', {
            headers: adminHeaders()
          });
          const data = await response.json();

          if (!response.ok) {
            container.innerHTML = `<div class="error-message">‚úó ${data.error || 'Failed to load keys'}</div>`;
            return;
          }

          if (!data.items.length) {
            container.innerHTML = '<div class="empty-state"><h3>No active keys</h3></div>';
            return;
          }

          container.innerHTML = data.items.map((item) => `
            <div class="review-item">
              <div><strong>${item.email}</strong> ‚Äî ${item.product}</div>
              <div style="margin-top:6px; font-family: monospace;">${item.licenseKey}</div>
              <div style="margin-top:6px; color:#666; font-size:12px;">${item.date || ''}</div>
              <div class="review-actions">
                <button class="btn btn-delete" onclick="deactivateKey('${item.email}','${item.licenseKey}','${item.product}')">Deactivate & Reissue</button>
              </div>
            </div>
          `).join('');
        } catch (err) {
          container.innerHTML = '<div class="error-message">‚úó Failed to load keys</div>';
        }
      }

      async function sendKeyReport() {
        const resultDiv = document.getElementById('activeKeysResult');
        resultDiv.innerHTML = '<p>Sending report...</p>';

        try {
          const response = await fetch('/api/admin/send-key-report', {
            method: 'POST',
            headers: adminHeaders()
          });
          const data = await response.json();

          if (response.ok) {
            resultDiv.innerHTML = `<div class="success-message">‚úì Report sent (${data.count} keys)</div>`;
          } else {
            resultDiv.innerHTML = `<div class="error-message">‚úó ${data.error || 'Failed to send report'}</div>`;
          }
        } catch (err) {
          resultDiv.innerHTML = '<div class="error-message">‚úó Failed to send report</div>';
        }
      }

      async function deactivateKey(email, oldKey, appName) {
        if (!confirm('Deactivate this key and issue a new one?')) return;
        const resultDiv = document.getElementById('activeKeysResult');
        resultDiv.innerHTML = '<p>Reissuing key...</p>';

        try {
          const response = await fetch('/api/admin/deactivate-key', {
            method: 'POST',
            headers: adminHeaders(),
            body: JSON.stringify({ email, oldKey, appName })
          });
          const data = await response.json();

          if (response.ok) {
            resultDiv.innerHTML = `<div class="success-message">‚úì New key sent: ${data.newKey}</div>`;
            loadActiveKeys();
          } else {
            resultDiv.innerHTML = `<div class="error-message">‚úó ${data.error || 'Failed to reissue key'}</div>`;
          }
        } catch (err) {
          resultDiv.innerHTML = '<div class="error-message">‚úó Failed to reissue key</div>';
        }
      }
      
      checkAuth();
      
      setInterval(() => {
        if (authToken) {
          loadPendingReviews();
          loadApprovedReviews();
        }
      }, 30000);
    </script>
  </body>
</html>
